pipeline {
  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    command: ["cat"]
    tty: true
  - name: git
    image: alpine/git
    command: ["cat"]
    tty: true
"""
      defaultContainer 'kaniko'
    }
  }

  environment {
    DOCKERHUB_USERNAME = credentials('cheeza42-username')
    DOCKERHUB_PASSWORD = credentials('cheeza42-password')
    IMAGE_NAME = 'docker.io/cheeza42/dockerizing-project'
    DOCKERFILE_PATH = 'dockerfile'
    BUILD_CONTEXT = '.'

    GITOPS_REPO_URL = 'https://github.com/cheeza42/Rolling_project_part_2.git'
    GITOPS_CREDENTIALS = 'github-creds'
    GITOPS_BASE_BRANCH = 'main'
    GITOPS_BRANCH = 'env-prod'
    MANIFEST_FILE = 'environments/prod/values.yaml'
    CHART_SRC_DIR = 'helm_chart_projct'
    CHART_DST_DIR = 'helm_chart_projct'
  }

  stages {
    stage('Clone Repository') {
      steps {
        git branch: 'main', url: 'https://github.com/cheeza42/Rolling_project_part_2.git'
      }
    }

    stage('Compute Tag') {
      steps {
        script {
          def ts = sh(returnStdout: true, script: "date +%Y%m%d-%H%M%S").trim()
          env.IMAGE_TAG = "${ts}"
          echo "IMAGE_TAG=${env.IMAGE_TAG}"
        }
      }
    }

    stage('Parallel Checks') {
      parallel {
        stage('Linting') {
          steps {
            sh 'echo "[MOCK] lint passed"'
          }
        }
        stage('Security Scan') {
          steps {
            sh 'echo "[MOCK] security scan passed"'
          }
        }
      }
    }

    stage('Build & Push (Kaniko)') {
      steps {
        sh """
          set -e
          mkdir -p /kaniko/.docker
          AUTH=\$(printf "%s" "${DOCKERHUB_USERNAME}:${DOCKERHUB_PASSWORD}" | base64 | tr -d '\\n')
          printf '{"auths":{"https://index.docker.io/v1/":{"auth":"%s"}}}\n' "\$AUTH" > /kaniko/.docker/config.json
          DF_REL="\${DOCKERFILE_PATH#\${BUILD_CONTEXT}/}"
          [ "\$DF_REL" = "\${DOCKERFILE_PATH}" ] && DF_REL="\${DOCKERFILE_PATH}"
          test -f "\${BUILD_CONTEXT}/\${DF_REL}" || { echo "Dockerfile not found at \${BUILD_CONTEXT}/\${DF_REL}"; exit 1; }
          /kaniko/executor \
            --verbosity=debug \
            --context="\${BUILD_CONTEXT}" \
            --dockerfile="\${DOCKERFILE_PATH}" \
            --destination="\${IMAGE_NAME}:\${IMAGE_TAG}" \
            --destination="\${IMAGE_NAME}:latest"
        """
      }
    }

    stage('gitops-preflight') {
      steps {
        container('git') {
          withCredentials([usernamePassword(credentialsId: "${GITOPS_CREDENTIALS}", usernameVariable: 'G_USER', passwordVariable: 'G_TOKEN')]) {
            sh '''
              set -e
              echo "==> Testing GitHub connectivity for ${GITOPS_REPO_URL}"
              GIT_CURL_VERBOSE=1 git ls-remote "https://${G_USER}:${G_TOKEN}@${GITOPS_REPO_URL#https://}" HEAD
            '''
          }
        }
      }
    }

    stage('gitops-init-branch') {
      steps {
        container('git') {
          dir('gitops-repo') {
            checkout([$class: 'GitSCM',
              branches: [[name: "*/${GITOPS_BASE_BRANCH}"]],
              userRemoteConfigs: [[url: "${GITOPS_REPO_URL}", credentialsId: "${GITOPS_CREDENTIALS}"]]
            ])
            sh """
              set -e
              git fetch origin
              if git ls-remote --exit-code --heads origin ${GITOPS_BRANCH} >/dev/null 2>&1; then
                echo "branch exists"
              else
                git checkout -B ${GITOPS_BRANCH} origin/${GITOPS_BASE_BRANCH}
                git push -u origin ${GITOPS_BRANCH}
              fi
            """
          }
        }
      }
    }

    stage('gitops-seed-once') {
      steps {
        container('git') {
          dir('gitops-repo') {
            checkout([$class: 'GitSCM',
              branches: [[name: "*/${GITOPS_BRANCH}"]],
              userRemoteConfigs: [[url: "${GITOPS_REPO_URL}", credentialsId: "${GITOPS_CREDENTIALS}"]]
            ])
            sh """
              set -e
              git config user.email "jenkins@local"
              git config user.name "jenkins"
              mkdir -p environments/prod
              [ -d "${CHART_DST_DIR}" ] || cp -R "${WORKSPACE}/${CHART_SRC_DIR}" "${CHART_DST_DIR}"
              if [ ! -f "${MANIFEST_FILE}" ]; then
                printf "image:\\n  repository: %s\\n  tag: %s\\n" "${IMAGE_NAME}" "${IMAGE_TAG}" > "${MANIFEST_FILE}"
              fi
              git add "${CHART_DST_DIR}" "${MANIFEST_FILE}" || true
              git diff --cached --quiet || { git commit -m "seed gitops"; git push origin ${GITOPS_BRANCH}; }
            """
          }
        }
      }
    }

    stage('gitops-update') {
      steps {
        container('git') {
          dir('gitops-repo') {
            checkout([$class: 'GitSCM',
              branches: [[name: "*/${GITOPS_BRANCH}"]],
              userRemoteConfigs: [[url: "${GITOPS_REPO_URL}", credentialsId: "${GITOPS_CREDENTIALS}"]]
            ])
            sh """
              set -e
              git config user.email "jenkins@local"
              git config user.name "jenkins"
              if [ ! -f "${MANIFEST_FILE}" ]; then
                printf "image:\\n  repository: %s\\n  tag: %s\\n" "${IMAGE_NAME}" "${IMAGE_TAG}" > "${MANIFEST_FILE}"
              else
                if grep -q '^[[:space:]]*repository:' "${MANIFEST_FILE}"; then
                  sed -i 's|^[[:space:]]*repository:.*|  repository: '"${IMAGE_NAME}"'|' "${MANIFEST_FILE}"
                else
                  sed -i '1i image:\\n  repository: '"${IMAGE_NAME}"'' "${MANIFEST_FILE}"
                fi
                if grep -q '^[[:space:]]*tag:' "${MANIFEST_FILE}"; then
                  sed -i 's|^[[:space:]]*tag:.*|  tag: '"${IMAGE_TAG}"'|' "${MANIFEST_FILE}"
                else
                  sed -i 's|^[[:space:]]*repository:.*|  repository: '"${IMAGE_NAME}"'\\n  tag: '"${IMAGE_TAG}"'|' "${MANIFEST_FILE}"
                fi
              fi
              git add "${MANIFEST_FILE}"
              git commit -m "set image ${IMAGE_NAME}:${IMAGE_TAG}" || echo "nothing to commit"
              git push origin ${GITOPS_BRANCH}
            """
          }
        }
      }
    }
  }

  post {
    success { echo "✅ done: ${IMAGE_NAME}:${IMAGE_TAG} -> ${GITOPS_BRANCH}" }
    failure { echo '❌ pipeline failed' }
  }
}
